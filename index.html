<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geodetic Benchmarks Map</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <!-- Google AdSense Script (your snippet for auto-ads) -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1638856822994397"
            crossorigin="anonymous"></script>
    <style>
        /* Full-window map with better theming */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 100%;
        }
        /* Loading spinner overlay - full-screen */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.8);
            justify-content: center;
            align-items: center;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Contact Button */
        #contact-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #contact-btn:hover {
            background-color: #2980b9;
        }
        /* Modal Styles */
        #contact-modal {
            display: none;
            position: fixed;
            z-index: 1002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }
        form {
            display: flex;
            flex-direction: column;
        }
        input, textarea {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button[type="submit"] {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 4px;
        }
        button[type="submit"]:hover {
            background-color: #219a52;
        }
        #form-feedback {
            margin-top: 10px;
            font-size: 14px;
        }
        /* Search Bar Styles */
        #search-container {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            background: white;
            padding: 5px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex;
        }
        #search-input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
            width: 200px;
        }
        #search-btn {
            padding: 5px 10px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
        #search-btn:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading"><div class="spinner"></div></div>
    <!-- Search Container -->
    <div id="search-container">
        <input type="text" id="search-input" list="benchmark-ids" placeholder="Enter Benchmark ID (e.g., 1-1)"> <!-- New: list attribute for autocomplete -->
        <button id="search-btn">Search</button>
    </div>
    <!-- New: Datalist for autocomplete (populated dynamically) -->
    <datalist id="benchmark-ids"></datalist>
    <!-- Contact Button -->
    <button id="contact-btn" title="Contact Us">?</button>
    <!-- Contact Modal -->
    <div id="contact-modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Contact Us</h2>
            <p>Report bugs, missing info, or ask questions about the benchmarks.</p>
            <form id="contact-form">
                <input type="text" id="name" placeholder="Your Name" required>
                <input type="email" id="email" placeholder="Your Email" required>
                <textarea id="message" placeholder="Your Message" rows="5" required></textarea>
                <button type="submit">Send</button>
            </form>
            <div id="form-feedback"></div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <script>
        let map;
        let userMarker;
        let baseLayers; // For switchable tiles
        let loadingTimeout; // For fallback hide
        let benchmarksCluster; // For clustered benchmarks
        let benchmarksData = []; // Store benchmarks for searching
        let benchmarkMarkers = new Map(); // Map ID to marker for quick access

        // Initialize the map
        function initMap() {
            // Default center (Winnipeg as fallback)
            const defaultCenter = [49.8951, -97.1384];
            map = L.map('map', {
                fullscreenControl: false, // No fullscreen button
                attributionControl: true
            }).setView(defaultCenter, 11); // Default zoom 11

            // Define switchable base layers
            baseLayers = {
                'Street Map': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }),
                'Satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                    maxZoom: 18
                }),
                'Terrain': L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (CC-BY-SA)',
                    maxZoom: 17
                })
            };

            // Add default layer and layers control
            baseLayers['Street Map'].addTo(map);
            L.control.layers(baseLayers).addTo(map);

            // Add scale control
            L.control.scale({ imperial: false }).addTo(map); // Metric scale

            // Initialize cluster group for benchmarks
            benchmarksCluster = L.markerClusterGroup();
            map.addLayer(benchmarksCluster);

            // Load benchmarks from JSON
            loadBenchmarks();

            // Request user's location with loading
            showLoading(true);
            getUserLocation();

            // Initialize EmailJS with your key
            emailjs.init('M8jgVemzgmiQn7Jte'); // From EmailJS dashboard

            // Setup search functionality
            setupSearch();
        }

        // Function to load benchmarks from JSON file
        async function loadBenchmarks() {
            try {
                const response = await fetch('benchmarks.json');
                benchmarksData = await response.json(); // Store data globally

                // New: Populate datalist for autocomplete
                const datalist = document.getElementById('benchmark-ids');
                benchmarksData.forEach(benchmark => {
                    const option = document.createElement('option');
                    option.value = benchmark.id;
                    datalist.appendChild(option);

                    // Existing marker creation...
                    const pos = [benchmark.lat, benchmark.lng];
                    const elev = benchmark.elev || ''; // Handle missing elev
                    const isBlankElev = !elev.trim(); // Check if blank/empty

                    // Choose color: black for blank elev, red for others
                    const dotColor = isBlankElev ? '#000000' : '#ff0000';

                    const marker = L.circleMarker(pos, {
                        title: benchmark.id,
                        alt: 'Benchmark marker',
                        radius: 6, // Slightly smaller than user dot for distinction
                        fillColor: dotColor,
                        color: dotColor,
                        fillOpacity: 1,
                        weight: 1 // Thin border
                    });

                    // Bind popup with id, elevation, description
                    marker.bindPopup(`
                        <b>ID:</b> ${benchmark.id}<br>
                        <b>Elevation:</b> ${elev || 'N/A'}<br>
                        <b>Description:</b> ${benchmark.desc || 'No description'}
                    `);

                    // Store marker by ID for quick access
                    benchmarkMarkers.set(benchmark.id.toLowerCase(), marker);

                    // Add to cluster group
                    benchmarksCluster.addLayer(marker);
                });
            } catch (error) {
                console.error('Error loading benchmarks:', error);
                alert('Failed to load benchmarks data. Check console for details.');
            }
        }

        // Setup search input and button
        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');

            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        }

        // Perform the ID search
        function performSearch() {
            const searchInput = document.getElementById('search-input');
            const query = searchInput.value.trim().toLowerCase();
            if (!query) {
                alert('Please enter a Benchmark ID.');
                return;
            }

            const marker = benchmarkMarkers.get(query);
            if (marker) {
                // Zoom and pan to the location with animation
                map.flyTo(marker.getLatLng(), 15, { duration: 1.0 });

                // Open the popup
                marker.openPopup();
            } else {
                alert('Benchmark ID not found. Try another ID.');
            }

            // Clear input for next search
            searchInput.value = '';
        }

        // Function to get and display user's location
        function getUserLocation() {
            if (navigator.geolocation) {
                loadingTimeout = setTimeout(() => {
                    showLoading(false);
                    alert('Location request timed out. Using default view without user location.');
                }, 10000);

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        clearTimeout(loadingTimeout);
                        const userPos = [position.coords.latitude, position.coords.longitude];

                        if (userMarker) {
                            map.removeLayer(userMarker);
                        }
                        userMarker = L.circleMarker(userPos, {
                            title: 'Your Location',
                            alt: 'User location marker',
                            radius: 8,
                            fillColor: '#3388ff',
                            color: '#3388ff',
                            fillOpacity: 1,
                            weight: 2
                        }).addTo(map)
                          .bindPopup('<b>Your Current Position</b><br>Lat: ' + userPos[0].toFixed(4) + '<br>Lng: ' + userPos[1].toFixed(4));

                        showLoading(false);
                    },
                    (error) => {
                        clearTimeout(loadingTimeout);
                        console.error('Error getting location:', error);
                        alert('Unable to get your location. Please enable location services or check permissions.');
                        showLoading(false);
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                alert('Geolocation is not supported by this browser.');
                showLoading(false);
            }
        }

        // Show/hide loading spinner
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        // Contact Modal Logic
        const modal = document.getElementById('contact-modal');
        const btn = document.getElementById('contact-btn');
        const closeBtn = document.getElementsByClassName('close')[0];
        const form = document.getElementById('contact-form');
        const feedback = document.getElementById('form-feedback');

        btn.onclick = () => { modal.style.display = 'flex'; };
        closeBtn.onclick = () => { modal.style.display = 'none'; };
        window.onclick = (event) => { if (event.target === modal) { modal.style.display = 'none'; } };

        form.onsubmit = (e) => {
            e.preventDefault();
            feedback.textContent = 'Sending...';
            feedback.style.color = 'blue';

            emailjs.send('service_g8bddtz', 'template_qdkr30n', {
                from_name: document.getElementById('name').value,
                from_email: document.getElementById('email').value,
                message: document.getElementById('message').value
            })
            .then(() => {
                feedback.textContent = 'Message sent successfully!';
                feedback.style.color = 'green';
                form.reset();
                setTimeout(() => { modal.style.display = 'none'; }, 2000);
            }, (error) => {
                console.error('EmailJS error:', error);
                feedback.textContent = 'Failed to send. Try again later.';
                feedback.style.color = 'red';
            });
        };

        // Load the map on page ready
        window.onload = initMap;
    </script>
</body>
</html>