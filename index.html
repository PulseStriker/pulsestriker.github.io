<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geodetic Benchmarks Map</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <!-- Google AdSense Script (your snippet for auto-ads) -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1638856822994397"
            crossorigin="anonymous"></script>
    <!-- QR Code lib for Bitcoin (optional; CDN) -->
    <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <style>
        /* Full-window map with better theming */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 100%;
        }
        /* Loading spinner overlay - full-screen */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.8);
            justify-content: center;
            align-items: center;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Contact Button */
        #contact-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #contact-btn:hover {
            background-color: #2980b9;
        }
        /* Modal Styles (for contact and report) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }
        form {
            display: flex;
            flex-direction: column;
        }
        input, textarea {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button[type="submit"] {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 4px;
        }
        button[type="submit"]:hover {
            background-color: #219a52;
        }
        #form-feedback, #report-feedback {
            margin-top: 10px;
            font-size: 14px;
        }
        /* Search Bar Styles */
        #search-container {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            background: white;
            padding: 5px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex;
        }
        #search-input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
            width: 200px;
        }
        #search-btn {
            padding: 5px 10px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
        #search-btn:hover {
            background: #2980b9;
        }
        /* Donate Button */
        #donate-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: #f39c12;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #donate-btn:hover {
            background-color: #e67e22;
        }
        /* Donate Modal Styles (similar to contact) */
        #donate-modal {
            display: none;
            position: fixed;
            z-index: 1002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .donate-content {
            background-color: #fefefe;
            margin: auto;
            padding: 15px; /* Reduced padding for mobile */
            border: 1px solid #888;
            width: 90%; /* Wider on small screens */
            max-width: 400px; /* Tighter max for better fit */
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            text-align: center;
        }
        #btc-qr {
            margin: 10px auto;
            width: 150px;
            height: 150px;
        }
        .donate-option {
            margin: 15px 0;
        }
        .donate-link {
            background-color: #3498db;
            color: white;
            padding: 10px;
            text-decoration: none;
            border-radius: 4px;
            display: inline-block;
        }
        .donate-link:hover {
            background-color: #2980b9;
        }
        /* Fix for long text overflow (e.g., BTC address) */
        .btc-address {
            word-break: break-all; /* Wrap long strings */
            font-family: monospace; /* Better readability for addresses */
            display: block;
            margin-top: 5px;
        }
        /* Bottom Slide-Up Panel */
        #benchmark-panel {
            position: fixed;
            bottom: -300px; /* Hidden below screen */
            left: 0;
            width: 100%;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            transition: bottom 0.3s ease-in-out;
            z-index: 1001;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            max-height: 300px; /* Initial height; expandable later */
        }
        #benchmark-panel.visible {
            bottom: 0; /* Slide up */
        }
        #panel-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        /* Report Button in Panel */
        #panel-report {
            position: absolute;
            top: 10px;
            right: 40px; /* Next to close */
            background: none;
            border: none;
            font-size: 16px;
            color: #e74c3c; /* Red for report */
            cursor: pointer;
        }
        #panel-report:hover {
            color: #c0392b;
        }
        #panel-content {
            margin-top: 20px;
        }
        /* Disclaimer Footer */
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.8); /* Semi-transparent over map */
            text-align: center;
            padding: 5px 0;
            font-size: 12px;
            color: #666;
            z-index: 1000; /* Above map but below controls/buttons */
        }
        /* Custom style for benchmark labels (optional tweaks) */
        .benchmark-label {
            background-color: rgba(255, 255, 255, 0.8); /* Semi-transparent bg */
            border: 1px solid #ccc;
            padding: 2px 5px;
            font-size: 12px;
            border-radius: 3px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading"><div class="spinner"></div></div>
    <!-- Search Container -->
    <div id="search-container">
        <input type="text" id="search-input" list="benchmark-ids" placeholder="Enter Benchmark ID (e.g., 1-1)">
        <button id="search-btn">Search</button>
    </div>
    <datalist id="benchmark-ids"></datalist>
    <!-- Donate Button -->
    <button id="donate-btn" title="Donate">ðŸ’°</button>
    <!-- Donate Modal -->
    <div id="donate-modal">
        <div class="donate-content">
            <span class="close">&times;</span>
            <h2>Support the Project</h2>
            <p>If this benchmarks map helps your work, consider a donation! Thanks for supporting geodetic tools for surveyors.</p>
            <div class="donate-option">
                <a href="https://www.buymeacoffee.com/Pulsestriker"><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a hot chocolate&emoji=â˜•&slug=Pulsestriker&button_colour=40DCA5&font_colour=ffffff&font_family=Comic&outline_colour=000000&coffee_colour=FFDD00" /></a>
            </div>
            <div class="donate-option">
                <strong>Bitcoin:</strong> <span class="btc-address">3NHguEkzt1WSUV36LgTbVPwyYDEQbbHdax</span>
                <div id="btc-qr"></div>
            </div>
        </div>
    </div>
    <!-- Contact Button -->
    <button id="contact-btn" title="Contact Us">?</button>
    <!-- Contact Modal -->
    <div id="contact-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Contact Us</h2>
            <p>Report bugs, missing info, or ask questions about the benchmarks.</p>
            <form id="contact-form">
                <input type="text" id="name" placeholder="Your Name" required>
                <input type="email" id="email" placeholder="Your Email" required>
                <textarea id="message" placeholder="Your Message" rows="5" required></textarea>
                <button type="submit">Send</button>
            </form>
            <div id="form-feedback"></div>
        </div>
    </div>
    <!-- Report Modal -->
    <div id="report-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Report Benchmark Issue</h2>
            <p>Describe the issue with this benchmark (e.g., wrong location, elevation error).</p>
            <form id="report-form">
                <input type="text" id="report-name" placeholder="Your Name (optional)">
                <input type="email" id="report-email" placeholder="Your Email (optional)">
                <textarea id="report-message" placeholder="Describe the issue..." rows="5" required></textarea>
                <button type="submit">Send Report</button>
            </form>
            <div id="report-feedback"></div>
        </div>
    </div>
    <!-- Bottom Slide-Up Panel -->
    <div id="benchmark-panel">
        <button id="panel-close">Ã—</button>
        <button id="panel-report">Report</button> <!-- Report button -->
        <div id="panel-content"></div>
    </div>
    <!-- Disclaimer Footer -->
    <footer>
        Note: Benchmark locations are approximate. There is no guarantee of accuracyâ€”use at your own risk and double-check data.
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <script>
        let map;
        let userMarker;
        let baseLayers; // For switchable tiles
        let loadingTimeout; // For fallback hide
        let elevCluster; // Cluster for benchmarks with elevation (red, default on)
        let noElevCluster; // Cluster for no-elevation (black, default off)
        let benchmarksData = []; // Store benchmarks for searching
        let benchmarkMarkers = new Map(); // Map ID to marker for quick access
        let currentBenchmark = null; // To store clicked benchmark data

        // Initialize the map
        function initMap() {
            // Default center (Winnipeg as fallback)
            const defaultCenter = [49.8951, -97.1384];
            map = L.map('map', {
                fullscreenControl: false, // No fullscreen button
                attributionControl: true
            }).setView(defaultCenter, 11); // Default zoom 11

            // Define switchable base layers (with Grayscale)
            baseLayers = {
                'Street Map': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }),
                'Grayscale': L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}{r}.png', {
                    attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 20,
                    subdomains: 'abcd'
                }),
                'Satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                    maxZoom: 18
                }),
                'Terrain': L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (CC-BY-SA)',
                    maxZoom: 17
                })
            };

            // Add default layer and layers control
            baseLayers['Street Map'].addTo(map);
            const layersControl = L.control.layers(baseLayers).addTo(map);

            // Add scale control
            L.control.scale({ imperial: false }).addTo(map); // Metric scale

            // Separate cluster groups
            elevCluster = L.markerClusterGroup();
            noElevCluster = L.markerClusterGroup();
            map.addLayer(elevCluster); // Elev on by default

            // Add no-elev to layers control as toggle (off by default)
            layersControl.addOverlay(noElevCluster, 'Show No-Elevation Benchmarks');

            // Load benchmarks from JSON
            loadBenchmarks();

            // Request user's location with loading
            showLoading(true);
            getUserLocation();

            // Initialize EmailJS with your key
            emailjs.init('M8jgVemzgmiQn7Jte'); // From EmailJS dashboard

            // Setup search functionality
            setupSearch();

            // Setup panel close button
            document.getElementById('panel-close').addEventListener('click', hidePanel);

            // Setup report button in panel
            document.getElementById('panel-report').addEventListener('click', showReportModal);
        }

        // Function to load benchmarks from JSON file
        async function loadBenchmarks() {
            try {
                const response = await fetch('benchmarks.json');
                benchmarksData = await response.json(); // Store data globally

                // Populate datalist for autocomplete
                const datalist = document.getElementById('benchmark-ids');
                benchmarksData.forEach(benchmark => {
                    const option = document.createElement('option');
                    option.value = benchmark.id;
                    datalist.appendChild(option);

                    const pos = [benchmark.lat, benchmark.lng];
                    const elev = benchmark.elev || ''; // Handle missing elev
                    const isBlankElev = !elev.trim(); // Check if blank/empty

                    // Choose color: black for blank elev, red for others
                    const dotColor = isBlankElev ? '#000000' : '#ff0000';

                    const marker = L.circleMarker(pos, {
                        title: benchmark.id,
                        alt: 'Benchmark marker',
                        radius: 6, // Slightly smaller than user dot for distinction
                        fillColor: dotColor,
                        color: dotColor,
                        fillOpacity: 1,
                        weight: 1 // Thin border
                    });

                    // Bind click event to show panel instead of popup
                    marker.on('click', () => showBenchmarkPanel(benchmark));

                    // New: Bind permanent tooltip as label (ID beside dot)
                    marker.bindTooltip(benchmark.id, {
                        permanent: true, // Always show
                        direction: 'right', // Beside to the right
                        offset: L.point(15, 0), // Offset from dot
                        className: 'benchmark-label', // Custom class for styling if needed
                        opacity: 0.9
                    });

                    // Store marker by ID for quick access
                    benchmarkMarkers.set(benchmark.id.toLowerCase(), marker);

                    // Add to appropriate cluster
                    if (isBlankElev) {
                        noElevCluster.addLayer(marker);
                    } else {
                        elevCluster.addLayer(marker);
                    }
                });
            } catch (error) {
                console.error('Error loading benchmarks:', error);
                alert('Failed to load benchmarks data. Check console for details.');
            }
        }

        // Show bottom panel with benchmark info
        function showBenchmarkPanel(benchmark) {
            const panelContent = document.getElementById('panel-content');
            panelContent.innerHTML = `
                <b>ID:</b> ${benchmark.id}<br>
                <b>Elevation:</b> ${benchmark.elev || 'N/A'}<br>
                <b>Description:</b> ${benchmark.desc || 'No description'}
            `;
            document.getElementById('benchmark-panel').classList.add('visible');
            currentBenchmark = benchmark; // Store for report
        }

        // Hide bottom panel
        function hidePanel() {
            document.getElementById('benchmark-panel').classList.remove('visible');
        }

        // Show report modal with prefilled subject
        function showReportModal() {
            if (!currentBenchmark) return;
            const reportModal = document.getElementById('report-modal');
            reportModal.style.display = 'flex';
            // Prefill subject in email (handled in submit)
        }

        // Hide report modal
        function hideReportModal() {
            document.getElementById('report-modal').style.display = 'none';
        }

        // Setup search input and button
        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');

            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        }

        // Perform the ID search
        function performSearch() {
            const searchInput = document.getElementById('search-input');
            const query = searchInput.value.trim().toLowerCase();
            if (!query) {
                alert('Please enter a Benchmark ID.');
                return;
            }

            const marker = benchmarkMarkers.get(query);
            if (marker) {
                // Zoom and pan to the location with animation
                map.flyTo(marker.getLatLng(), 15, { duration: 1.0 });

                // Simulate click to show panel
                marker.fire('click');
            } else {
                alert('Benchmark ID not found. Try another ID.');
            }

            // Clear input for next search
            searchInput.value = '';
        }

        // Function to get and display user's location
        function getUserLocation() {
            if (navigator.geolocation) {
                loadingTimeout = setTimeout(() => {
                    showLoading(false);
                    alert('Location request timed out. Using default view without user location.');
                }, 10000);

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        clearTimeout(loadingTimeout);
                        const userPos = [position.coords.latitude, position.coords.longitude];

                        if (userMarker) {
                            map.removeLayer(userMarker);
                        }
                        userMarker = L.circleMarker(userPos, {
                            title: 'Your Location',
                            alt: 'User location marker',
                            radius: 8,
                            fillColor: '#3388ff',
                            color: '#3388ff',
                            fillOpacity: 1,
                            weight: 2
                        }).addTo(map)
                          .bindPopup('<b>Your Current Position</b><br>Lat: ' + userPos[0].toFixed(4) + '<br>Lng: ' + userPos[1].toFixed(4));

                        showLoading(false);
                    },
                    (error) => {
                        clearTimeout(loadingTimeout);
                        console.error('Error getting location:', error);
                        alert('Unable to get your location. Please enable location services or check permissions.');
                        showLoading(false);
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                alert('Geolocation is not supported by this browser.');
                showLoading(false);
            }
        }

        // Show/hide loading spinner
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        // Contact Modal Logic
        const modal = document.getElementById('contact-modal');
        const btn = document.getElementById('contact-btn');
        const closeBtn = modal.querySelector('.close');
        const form = document.getElementById('contact-form');
        const feedback = document.getElementById('form-feedback');

        btn.onclick = () => { modal.style.display = 'flex'; };
        closeBtn.onclick = () => { modal.style.display = 'none'; };
        window.addEventListener('click', (event) => {
            if (event.target === modal) { modal.style.display = 'none'; }
        });

        form.onsubmit = (e) => {
            e.preventDefault();
            feedback.textContent = 'Sending...';
            feedback.style.color = 'blue';

            emailjs.send('service_g8bddtz', 'template_qdkr30n', {
                from_name: document.getElementById('name').value,
                from_email: document.getElementById('email').value,
                message: document.getElementById('message').value
            })
            .then(() => {
                feedback.textContent = 'Message sent successfully!';
                feedback.style.color = 'green';
                form.reset();
                setTimeout(() => { modal.style.display = 'none'; }, 2000);
            }, (error) => {
                console.error('EmailJS error:', error);
                feedback.textContent = 'Failed to send. Try again later.';
                feedback.style.color = 'red';
            });
        };

        // Report Modal Logic (similar to contact)
        const reportModal = document.getElementById('report-modal');
        const reportCloseBtn = reportModal.querySelector('.close');
        const reportForm = document.getElementById('report-form');
        const reportFeedback = document.getElementById('report-feedback');

        reportCloseBtn.onclick = hideReportModal;
        window.addEventListener('click', (event) => {
            if (event.target === reportModal) hideReportModal();
        });

        reportForm.onsubmit = (e) => {
            e.preventDefault();
            reportFeedback.textContent = 'Sending...';
            reportFeedback.style.color = 'blue';

            emailjs.send('service_g8bddtz', 'template_qdkr30n', {
                from_name: document.getElementById('report-name').value || 'Anonymous',
                from_email: document.getElementById('report-email').value || 'no-reply@example.com',
                message: document.getElementById('report-message').value,
                subject: `Report for Benchmark ID: ${currentBenchmark.id}` // Prefilled subject
            })
            .then(() => {
                reportFeedback.textContent = 'Report sent successfully!';
                reportFeedback.style.color = 'green';
                reportForm.reset();
                setTimeout(hideReportModal, 2000);
            }, (error) => {
                console.error('EmailJS error:', error);
                reportFeedback.textContent = 'Failed to send. Try again later.';
                reportFeedback.style.color = 'red';
            });
        };

        // Donate Modal Logic
        const donateModal = document.getElementById('donate-modal');
        const donateBtn = document.getElementById('donate-btn');
        const donateCloseBtn = donateModal.querySelector('.close');

        donateBtn.onclick = () => { 
            donateModal.style.display = 'flex'; 
            generateBtcQr(); // Generate QR on open
        };
        donateCloseBtn.onclick = () => { donateModal.style.display = 'none'; };
        window.addEventListener('click', (event) => {
            if (event.target === donateModal) { donateModal.style.display = 'none'; }
        });

        // Generate Bitcoin QR (optional; remove if using static image)
        function generateBtcQr() {
            const qr = new QRCodeStyling({
                width: 150,
                height: 150,
                data: '3NHguEkzt1WSUV36LgTbVPwyYDEQbbHdax', // Your Kraken BTC address
                image: '', // Optional logo
                dotsOptions: { color: '#000' },
                backgroundOptions: { color: '#fff' }
            });
            const qrContainer = document.getElementById('btc-qr');
            qrContainer.innerHTML = ''; // Clear previous
            qr.append(qrContainer);
        }

        // Load the map on page ready
        window.onload = initMap;
    </script>
</body>
</html>